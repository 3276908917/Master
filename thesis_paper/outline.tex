% Some miscellaneous notes:
% I will indicate with my sigil the yellow-folder note pages that I've already
% digitized.

\documentclass[11pt]{article}
\usepackage{reports}

% The following block isn't actually used on the output.
% But it's easier to simply fill it out than to try
% to edit the rather fragile reports.sty file.
\newcommand*{\instr}{Ariel S\'{a}nchez}
\newcommand*{\term}{31.07.2023}
\newcommand*{\coursenum}{Master's Thesis}
\newcommand*{\hwnum}{Redshift Dependence of Neutrino Damping on the Power
Spectrum}

\usepackage{pdfpages}
\usepackage{bm}
\usepackage{listings}
\usepackage{titling}
\usepackage[normalem]{ulem} 

\IfFileExists{biblatex.sty} {
    \usepackage[style=authoryear]{biblatex}
    \addbibresource{master_thesis.bib}
}

% This code formatting sucks but I don't want to output extra spaces.
\newcommand{\cbib}[1]
{\IfFileExists{biblatex.sty}
{\cite{#1}}
{[citation ``#1'' cannot be linked in the current environment]}}

\graphicspath{{./res/}}

\begin{document}

\fontsize{12}{15}

\begin{center}
Lukas Finkbeiner: Master's Thesis
\end{center}

\tableofcontents

\begin{centering}
\section{Abstract}
\end{centering}

``The goal of this project is to produce an emulator of the linear-theory
power spectrum based on evolution mapping'' (A. G. S\'{a}nchez, private
communication). In particular, this paper seeks to extend the evolution mapping
scheme of \cbib{San21} to massive-neutrino cosmologies by applying a correction
factor to results from emulators built on massless-neutrino simulations.  We find that the scalar mode amplitude $A_s$ can be used to quantify the suppression of structure growth due to massive neutrinos. Consequently, by including this parameter, we can successfully train over the physical density of the universe in massive neutrinos.

\begin{centering}
\section{Introduction, Theory, and Background}
\end{centering}

I have a lot of different important concepts that I need to get through, so I can easily imagine this becoming a relatively long introduction compared to other master's theses.

\begin{centering}
\subsection{The Matter Power Spectrum}
\end{centering}

A primary goal of cosmology is to specify, as narrowly as possible, the parameters which define our Universe. These include, for example, the overall curvature of the Universe as well as its cold dark matter (CDM) content.

Next, I want to talk about one powerful result, the power spectrum. The power spectrum can be probed in many different ways, and its precise shape and amplitude can tell us about several of these cosmological parameters.

Actually, the power spectra we are discussing in this thesis are linear-theory power spectra of non-neutrino matter. But anyway, here I will cover some of the tried-and-true basic explanations of what the power spectrum is and why it is interesting for the question of parameter inference. 

\begin{centering}
\subsection{Boltzmann Solvers and CAMB}
\end{centering}

I want to talk about what a Boltzmann solver is and what kinds of equations it is solving.

To hint at what's to come, I start off this section by noting that several cosmological parameters have a fairly unique impact on the shape of the power spectrum, while others have a degenerate impact. Wouldn't it be great if we could know what the power spectrum would look like if we increased parameter $x$? Boltzmann solvers can help us with that.

This will mostly just be a theoretical discussion of these solvers. The hands-on stuff comes in the non-introductory section on CAMB.

I will also mention a couple of specific Boltzmann solvers, like CLASS and CAMB. I will briefly justify our use of CAMB over CLASS.

\begin{centering}
\subsection{Monte Carlo Markov Chains}
\end{centering}

This can be a very brief section, but I want to discuss a little bit of how most modern parameter inference works because it motivates the need for extremely fast power spectrum computation. It provides a sort of conceptual bridge between our ``pure'' goal (quantifying the cosmos) and the nitty-gritty bulk of the paper (optimizing emulator performance).

\begin{centering}
\label{sec: state_of_the_art}
\subsection{Emulation, Gausian Processes, and Latin Hypercube Sampling}
\end{centering}

To conduct these MCMC analyses, we need several thousands of power spectra. However, if our Boltzmann solvers take on the order of three seconds to run, then these solvers will become the bottleneck of our analysis.

This motivates the introduction of emulation, basically multi-dimensional interpolation, in order to predict the power spectra. These predictions are orders of magnitude less time-expensive. 

Most emulators are based on a Gaussian Process (GP). A GP is a Gaussian
distribution over functions\footnote
{A GP is the limit of a one-hidden-layer neural network as the number of
neurons approaches infinity.}, which can be interpreted
as the infinite-dimensional generalization of the multivariate normal
distribution. The inference of continuous values with a GP prior
is known as Gaussian process regression, or Kriging. GP regression is a
powerful non-linear multivariate interpolation tool. The computational
complexity of inference and likelihood evaluation within GP regression is cubic
in the number of points. This makes GP regression an excellent companion to
Latin hypercube sampling (LHS), which makes highly-efficient use of a limited number of samples. GP-based emulators require fewer training samples than
neural networks but provide smaller speedups. GP's allow natural propagation of
uncertainty in predictions to the final posterior distribution; neural
networks lack this feature.

Emulators interpolate across a high-dimensional parameter space. The primary
limitation is that the emulator has to be built with every possible parameter
in mind that an end-user could wish to vary. Yet there is a large number of
different cosmological parameters discussed in the modern literature.
``Currently available emulators only sample a few cosmological parameters,
often with restrictive ranges, and are not applicable to more general parameter
spaces'' (\cbib{San21}). ``Due to the high computational cost of the required
simulations, [...] current emulators leave out parameters such as the curvature
of the Universe or dynamic energy models beyond the standard CPL
parametrization'' (\cbib{San21}).

I'll talk a little about different emulators currently available, such as COMET. Some emulate non-linear power spectra, for example, but most lack this physical density in neutrinos. That is where Cassandra-linear, the emulator of this thesis, comes in.

\begin{centering}
\subsection{Evolution Mapping}
\end{centering}

This section will also include an extremely brief summary of Ariel's paper motivating the use of $\sigma_{12}$ instead of $\sigma_8$.

    I have two primary objectives for this section: explain the unit system
    we are using (ditch $h$ factor because it messes up everything--but
    only briefly summarize the main arguments of Sanchez 2020), and briefly
    summarize why we can funnel all of the evolution parameters through
    $\sigma_{12}$ in this way. Unfortunately, this second objective will
    almost certainly require you to bust out a few equations, and even to
    manipulate them a little to tease out relations essential to this paper.

Conventional emulator calibration entails the historical units of Mpc / $h$,
but if we use instead units of Mpc, then we can distill all of the evolution
parameters into one parameter, $\sigma_{12}$. Since $h$ is already its own parameter, the conventional $\sigma_8$ parameter is truly a mixture
of two parameters. This presents a host of misleading results  and statistical
ambiguities (\cbib{San20}) which are outside of the scope of this work but
which prompt us to abandon $\sigma_8$.
Similarly, throughout this paper we will refrain from using the conventional
fractional density parameters $\Omega_i$ in favor of the physical density
parameters $\omega_i = \Omega_i h^2$ which similarly eliminate the
dependence on $h$.

(\cbib{San21}) proposes to divide up the full set of cosmological
parameters into two categories: \textit{evolution} parameters $\mathcal{O}_E$
(such as $\omega_b$, $\omega_c$, and $\eta_s$)
affect the amplitude of the power spectrum at a particular redshift, while
\textit{shape} parameters $\mathcal{O}_S$
(such as $\omega_K$, $\omega_\text{DE}$, w(a))
affect the shape of the power
spectrum.

We take, as the evolution mapping relation for the power spectrum, equation 13
from \cbib{San21}:

\begin{equation}
\label{eq: evMapping_pSpectrum}
    \Delta^2_L (k | z, \Theta_s, \Theta_e)
    =
    \Delta_L^2 (k | \Theta_s, \sigma_{12} \left( z, \Theta_s, \Theta_e \right))
\end{equation}

Why is this scheme important? Evolution mapping greatly simplifies the emulator
implementation. Because we can
funnel all of the evolution parameters through $\sigma_{12}$, we've effectively
collapsed an entire category of parameters to just one parameter. Fewer
parameters means that we get a faster emulator.

``At the linear level, all models characterized by identical shape parameters
and the same values of the parameter combinations $b \sigma_{12}(z)$ and
$f \sigma_{12}(z)$ will be identical'' (\cbib{San21}).

Now, for the hiccup, which segues into the next section: this scheme is broken by one parameter, the Universe's
density in neutrinos. (In the next section: why this is so and what we can do
about it.)

\begin{centering}
\subsection{Neutrinos and Their Cosmological Impact}
\end{centering}

(\cbib{Kiakotou}): ``Neutrinos with masses on the eV scale or below will be a
hot component of the dark matter and will free-stream out of overdensities and
thus wipe out small-scale structures.''

``In general, a larger density of relativistic species leads to a smaller
growth of matter fluctuations'' (\cbib{Zennaro}).


The point of this section is: why is $\omega_\nu$ bad for the
evolution mapping scheme? Because neutrinos exhibit redshift-dependent
damping of the power-spectrum, and therefore affect both the shape and the
amplitude of the power spectrum. Whenever massive neutrinos are present,
the growth factor becomes scale-dependent, which disrupts the
evolution-mapping scheme.

Why do they behave in this way? All neutrinos start off as
relativistic particles in the early Universe, acting as a type of radiation.
But as the Universe continues to expand and cool, the neutrinos behave
increasingly like dark matter.
In this way, the physical density in neutrinos impacts both the shape and the
evolution.

``The popular heuristic formula for the linear theory suppression of the matter
fluctuations by free-streaming $\nu$, $\Delta P(k) / P(k) \approx -8 f_\nu$, is
valid only on very small scales $k > 0.8 h$ / Mpc, However, it is not of
practical use as this is in the strongly nonlinear regime of matter
clustering'' (\cbib{Kiakotou}).

One proposed solution is to treat the neutrinos as a small correction factor
to the results from an anologous cosmology with the same $\omega_m$ but with
$\omega_\nu = 0$. This of course limits the applicability of our emulator to
cosmologies with very small $\omega_\nu$, but this constraint agrees with
current observations (\textcolor{orange}{which?}).

I want to end this section with a vague plan of action: we want to play around with CAMB power spectra to see if there are any simple ways around this limitation in our approach.

\begin{centering}
\section{CAMB, Initial Setup}
\end{centering}

CAMB is a Fortran code with a Python wrapper\footnote{
\url{https://github.com/cmbant/CAMB}
}which we will be using for the
entirety of this project.

To introduce the reader to the scope of CAMB, we will now introduce
some basic simulated power spectra along with a summary of the dynamic
parameters which will be of greatest interest to us.

I hope to, in painstaking detail, cover many of the lines of the code that I have written to interface with CAMB. I will include plots to indicate, at every step, what incorrect settings cause the power spectrum to look like (or, for subtler errors, what the error curves looked like compared to Ariel's results, which I treated as a sort of "ground truth"). This should also be a good example to flex my physics interpretation skills: why does this incorrect setting produce this undesired pattern?

You might think that this is sort of an inappropriate section for a master's thesis (especially since I have in mind that this be a lengthy section), but I would like to include it unless you feel very strongly. After all, I spent several months of the project debugging at least ten different ways that slight and major errors in the various settings led to irreconcilable results.

For example, one parameter that tripped me up for a while: neutrino mass hierarchy: the options are degenerate, normal, and inverted. The CAMB documentation annotates this parameter as ``(1 or 2 eigenstate approximation),'' but this is somewhat unclear. Is the degenerate hierarchy the single mass eigenstate approximation? Do both normal and inverted hierarchies involve two eigenstates?

In figure \ref{fig: spectrum_type}, we can see that requesting of the wrong
power spectrum type can in some low-$\omega_\nu$ cases yields errors so low
that we might accidentally overlook them. This error pattern is easily
recognizable and is a consequence of the definition of the power spectrum: the
Fourier transform  of the two-point correlation function. ...Okay, I'm still thinking about this. I don't understand yet, but I'll be sure to ask you if I'm still struggling about it.


\begin{centering}
\section{Cassandra-Linear: a Python Package}
\end{centering}

This will be a rather long, dry, and technical section with subsections based on each of the core scripts making up the Python package that I have been developing. It will in some ways paraphrase and summarize the documentation, explaining the basic use of the package as well as important limitations. Of course, fairly early on in this section, there will be a footnote linking to my GitHub repository, which will be made public once I'm ready to hand in this thesis.

Even if my code doesn't end up in a bigger repository, I nevertheless think that it's important to the scientific process that I describe in detail the code that I have written. Besides, if any readers want to experiment specifically with the ideas discussed in this thesis, they may find my code more accessible because it is, in a sense, "single-purpose"--that is to say, written almost exclusively to investigate the topics of this paper.

\begin{centering}
\section{Results and Analysis}
\end{centering}

\begin{centering}
\subsection{Quantifying the Performance of the Emulator}
\end{centering}

Before I even show any results for this emulator, I would like to motivate the challenge of gauging the accuracy and reliability of the emulator. Since we have to quantify performance over a hypervolume of parameter space, there is no concept of, for example, a chi-squared test that can applied here. So I am trying to pre-empt objections like those raised by Stella.

I would like to include a brief review of the relevant literature to explain the kinds of performance metrics that are most commonly applied in emulator papers (as I remember, largely percent-level bounds when comparing against ground truth data sets). Then, I would like to break down Ariel's arguments for why absolute error is of greater consequence to us than relative errors.

For the purpose of this paper, we use the weak and approximate performance metric of simply generating a large number of additional CAMB spectra and comparing them to the predictions of the emulator.

\begin{centering}
\subsection{Percent and Absolute Errors on Random Cosmologies}
\end{centering}

This will be a fairly short section, basically just showing the plot of 5000 error curves in these two ways. I may focus in on different k-ranges, but the error curves are currently quite flat, so I don't think that would be a good use of space.

Furthermore, I will try to select a couple of cosmologies out of the 5000 (maybe a low-error case and a high-error case) as examples of the performance on just one at a time. But I'm not sure how insightful that will be, I don't know if that will tell the reader a whole lot.

\begin{centering}
\subsection{Performance in Different Parameters}
\end{centering}

Here, I will either include color plots or, as Dante suggests, monochrome plots with error as one axis and parameter value as the other (i.e. $k$ fixed). Then, if I haven't tightened the $\sigma_{12}$ performance by the time of submission, I can talk about how this is the most promising avenue for refinement of the emulator. In any case, I plan to spend some time talking about \textit{why} parameter x is the current biggest problem for the emulator. 

\begin{centering}
\section{Discussion}
\end{centering}

\begin{centering}
\subsection{Future Work}
\end{centering}

Here I will talk about what kinds of questions we estimate will be most fruitful for further inquiries about this topic and this code.

\IfFileExists{biblatex.sty} {
    \printbibliography
}

\end{document}
